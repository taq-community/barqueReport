---
title: "Rapport d'Analyse Métagénomique - 12S"
subtitle: ""
date: today
params:
  barque_output_folder: "/home/steve/Documents/git/barque/12_results"
  config_file: "/home/steve/Documents/git/barque/99_logfiles/20251120_181640_barque_config.sh"
  primer_file: "/home/steve/Documents/git/barque/99_logfiles/20251120_181640_primers.csv"
  samples_ids: ["M1", "M2", "M3", "M4", "M5"]
  title_short: "Rapport 12S"
  client_name: ""
  geographic_region: ""
  sampling_date: ""
  lab_author: ""
  bioinfo_author: ""
  report_author: ""
title-short: "`r params$title_short`"
client-name: "`r params$client_name`"
cover-image: "`r system.file('images/cover.png', package = 'barqueReport')`"
lab-author: "`r params$lab_author`"
bioinfo-author: "`r params$bioinfo_author`"
report-author: "`r params$report_author`"
format:
  pdf:
    template: template.tex
    toc: true
    toc-depth: 2
    toc-title: "Table des matières"
    number-sections: true
    highlight-style: github
    colorlinks: true
    keep-tex: false
    include-in-header:
      text: |
        \usepackage[french]{babel}
        \usepackage{parskip}
        \definecolor{customblue}{HTML}{3a6881}
        \hypersetup{linkcolor=customblue, urlcolor=customblue, citecolor=customblue}
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(dplyr)
library(readr)
library(knitr)
library(kableExtra)
library(ggplot2)

# Load barque data
barque_data <- barqueReport::load_barque_data(params$barque_output_folder, params$samples_ids)
single_hits <- barque_data$single_hits
multi_hits <- barque_data$multi_hits

# Calculate stats
stats <- barqueReport::barque_summary_stats(single_hits, multi_hits, params$samples_ids)

# Load dropout data
dropout_data <- readr::read_csv(file.path(params$barque_output_folder, "sequence_dropout.csv"), show_col_types = FALSE) |>
  dplyr::filter(Sample %in% params$samples_ids)

# Calculate metrics
metrics <- dropout_data |>
  dplyr::summarise(
    brutes = sum(`04_data`, na.rm = TRUE),
    trimmed = sum(`05_trimmed`, na.rm = TRUE),
    merged = sum(`06_merged`, na.rm = TRUE),
    split = sum(`07_split_amplicons`, na.rm = TRUE),
    chimeres = sum(`08_chimeras`, na.rm = TRUE),
    annotees = sum(`12_results`, na.rm = TRUE)
  )

# Extract config values
config_lines <- readLines(params$config_file)

get_config <- function(param) {
  line <- grep(paste0("^", param, "="), config_lines, value = TRUE)
  value <- gsub("^[^=]+=([0-9.]+).*", "\\1", line)
  as.numeric(value)
}

config <- list(
  min_hits_sample = get_config("MIN_HITS_SAMPLE"),
  min_hits_experiment = get_config("MIN_HITS_EXPERIMENT")
)

# Extract primer properties (header is first line with #, data is first line without #)
primer_lines <- readLines(params$primer_file)
primer_header <- strsplit(sub("^#", "", primer_lines[1]), ",")[[1]]
primer <- read_csv(params$primer_file, comment = "#", col_names = primer_header, show_col_types = FALSE) |>
  as.list()
```

# Information sur le projet

Ce rapport présente les résultats de l'analyse métagénomique 12S réalisée pour `r params$client_name` dans la région de `r params$geographic_region`. L'objectif de cette étude est l'identification de la diversité des espèces aquatiques. L'échantillonnage a été réalisé par `r params$client_name` dans `r params$region_geographique` en `r params$sampling_date`. Au total, `r stats$samples` échantillons ont été analysés pour le marqueur 12S (`r paste(params$samples_ids, collapse = ", ")`).

# Méthodes & Résultats

## Métagénomique en laboratoire

L'analyse utilise des amroces 12S MiFish-U-F et U-R (Miya et al. 2015), avec une taille d'amplicon de 174 bp. L'approche PCR repose sur une combinaison unique de 2 barcodes de 8 bp. Aucune dilution n'est effectuée, et 3 µl d'ADN sont utilisés par réplicat de PCR. Cinq réplicats techniques sont réalisés par échantillon testé, avec 35 cycles PCR. Le séquençage est effectué sur MiSeq i100, Illumina Inc.

## Analyse bio-informatique

Le post-traitement des données séquencés est effectué avec Barque (https://github.com/enormandeau/barque). Le pipeline Barque traite les séquences en plusieurs étapes successives. Les séquences brutes obtenues du séquenceur passent d'abord par une étape de *trimming* pour retirer les amorces et les portions de mauvaise qualité. Ensuite, les lectures 3" et 5" sont combinées (*merge*) pour reconstituer l'amplicon complet. L'étape de *split* permet de classifier les amplicons selon les marqueurs ciblés afin de conserver ceux d'une longueur supérieure à `r primer$MinAmpliconSize` et inférieure à `r primer$MaxAmpliconSize`. Les séquences chimériques, qui sont des artefacts de PCR, sont ensuite éliminées.


```{r}
#| label: tbl-results-summary
#| tbl-cap: "Résumé de l'analyse métagénomique 12S"

results_data <- data.frame(
  Parametre = c(
    "Nombre total de séquences",
    "Nombre total de séquences annotées",
    "Nombre d'espèces détectées",
    "Nombre de groupes ambigus (Multiple Hits)",
    "Taux d'annotation"
  ),
  Valeur = c(
    format(metrics$brutes, big.mark = " "),
    format(metrics$annotees, big.mark = " "),
    as.character(stats$single_species),
    as.character(stats$multi_groups),
    paste0(round((metrics$annotees / metrics$brutes) * 100, 1), "% des séquences brutes")
  )
)

knitr::kable(results_data, col.names = c("", ""))
```


```{r}
#| label: tbl-sequencing-steps
#| tbl-cap: "Tableau du nombre de lectures écartées lors du post-traitement des données de séquençage par le pipeline Barque"

# Prepare data with samples in rows and steps in columns
steps <- c("04_data", "05_trimmed", "06_merged", "07_split_amplicons", "08_chimeras", "12_results")
step_labels <- c("Brutes", "Trimming", "Merge", "Split", "Chimères", "Annotées")

sequencing_data <- data.frame(Sample = character(), stringsAsFactors = FALSE)

for (sample_id in params$samples_ids) {
  sample_dropout <- dropout_data |> dplyr::filter(Sample == sample_id)
  values <- c(
    sample_dropout$`04_data`,
    sample_dropout$`05_trimmed`,
    sample_dropout$`06_merged`,
    sample_dropout$`07_split_amplicons`,
    sample_dropout$`08_chimeras`,
    sample_dropout$`12_results`
  )
  brutes <- values[1]
  row_data <- c(format(brutes, big.mark = " "), sapply(2:length(values), function(i) {
    diff <- values[i-1] - values[i]
    pct <- round(diff / brutes * 100, 1)
    paste0(format(values[i], big.mark = " "), " (-", pct, "%)")
  }))
  sequencing_data <- rbind(sequencing_data, c(sample_id, row_data))
}

colnames(sequencing_data) <- c("Échantillon", step_labels)

# Add total row
total_values <- c(
  sum(dropout_data$`04_data`),
  sum(dropout_data$`05_trimmed`),
  sum(dropout_data$`06_merged`),
  sum(dropout_data$`07_split_amplicons`),
  sum(dropout_data$`08_chimeras`),
  sum(dropout_data$`12_results`)
)
total_brutes <- total_values[1]
total_row <- c("Total", format(total_brutes, big.mark = " "), sapply(2:length(total_values), function(i) {
  diff <- total_values[i-1] - total_values[i]
  pct <- round(diff / total_brutes * 100, 1)
  paste0(format(total_values[i], big.mark = " "), " (-", pct, "%)")
}))
sequencing_data <- rbind(sequencing_data, total_row)

knitr::kable(sequencing_data, format = "latex", booktabs = TRUE) |>
  kableExtra::kable_styling(latex_options = c("scale_down", "hold_position")) |>
  kableExtra::row_spec(nrow(sequencing_data) - 1, extra_latex_after = "\\midrule")
```

 Finalement, les séquences restantes sont annotées en les assignant à une espèce présente dans la base de données contenue dans le pipeline BARQUE. Cette base de données est constituée des séquences de référence de MitoFish (Iwasaki et al. 2013), GenBank ainsi que des séquences de référence de l'Institut de biologie intégrative et des systèmes (IBIS) à Laval.  Pour obtenir une identification positive, le niveau de similarité minimale entre la séquence obtenue et celles présentes dans la base de données de référence a été fixé à `r primer$SimilSpecies * 100`%.

Les espèces qui n'ont pas fait l'objet d'une detection d'au moins `r config$min_hits_sample` séquences dans un échantillon et au moins `r config$min_hits_experiment` séquences sur l'ensemble des échantillons sont retirées de l'analyse afin de limiter les erreurs d'identification (Brown et al., 2015; Schnell, Bohmann, & Gilbert, 2015).


```{r}
#| label: fig-reads-filtered-out
#| fig-cap: "Figure du nombre de lectures écartées lors du post-traitement des données de séquençage par le pipeline Barque"
#| fig-width: 10
#| fig-height: 6

# Load and process sequence dropout data
dropout_long <- barqueReport::load_dropout_data(params$barque_output_folder, params$samples_ids) |>
  dplyr::mutate(
    step_label = dplyr::case_when(
      step == "04_data" ~ "Séquences brutes",
      step == "05_trimmed" ~ "Filtration",
      step == "06_merged" ~ "Fusion",
      step == "07_split_amplicons" ~ "Classification",
      step == "08_chimeras" ~ "Retrait chimères",
      step == "12_results" ~ "Séquences finales",
      TRUE ~ step
    ),
    step_order = dplyr::case_when(
      step == "04_data" ~ 1,
      step == "05_trimmed" ~ 2,
      step == "06_merged" ~ 3,
      step == "07_split_amplicons" ~ 4,
      step == "08_chimeras" ~ 5,
      step == "12_results" ~ 6,
      TRUE ~ 0
    )
  ) |>
  dplyr::arrange(Sample, step_order)

# Create ggplot2 plot
ggplot2::ggplot(dropout_long, ggplot2::aes(x = stats::reorder(step_label, step_order), y = sequences, group = Sample, color = Sample)) +
  ggplot2::geom_line(linewidth = 0.8, alpha = 0.8) +
  ggplot2::geom_point(size = 2.5, alpha = 0.8) +
  ggplot2::scale_colour_manual(values = grDevices::colorRampPalette(MetBrewer::met.brewer("Signac", 13))(length(params$samples_ids))) +
  ggplot2::scale_y_continuous(labels = scales::label_number(big.mark = " ")) +
  ggplot2::labs(
    x = "",
    y = "Nombre de séquences",
    color = "Échantillons"
  ) +
  ggplot2::theme_light(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    legend.position = "right",
    panel.grid.minor = ggplot2::element_blank()
  ) +
  ggplot2::guides(color = ggplot2::guide_legend(override.aes = list(size = 3)))
```

{{< pagebreak >}}

# Liste des espèces détectées

```{r}
#| label: tbl-species-by-sample
#| results: asis
#| eval: false

# Generate one table per sample
for (sample_id in params$samples_ids) {
  sample_id = params$samples_ids[1]
  # Filter species detected in this sample (reads > 0)
  sample_species <- single_hits |>
    dplyr::select(Group, Species, dplyr::all_of(sample_id)) |>
    dplyr::rename(Reads = dplyr::all_of(sample_id)) |>
    dplyr::filter(Reads > 0) |>
    dplyr::arrange(desc(Reads))

  # Print section header for this sample
  cat("\n\n## Échantillon : ", sample_id, "\n\n", sep = "")

  if (nrow(sample_species) > 0) {
    # Print the table
    print(knitr::kable(
      sample_species,
      col.names = c("Groupe", "Espèce", "Lectures"),
      format.args = list(big.mark = " "),
      caption = paste0("Espèces détectées dans l'échantillon ", sample_id)
    ))
  } else {
    cat("*Aucune espèce détectée dans cet échantillon.*\n\n")
  }

  cat("\n\n")
}
```

{{< pagebreak >}}

# Conclusion


## Avertissements – Limites de l'approche

Il est important de considérer les limites de ce genre d’étude en ce qui a trait aux espèces détectées. Certaines espèces ne peuvent avoir été détectées par cette méthode étant donné leur rareté (faible présence/absence) ou parce qu’elles n’étaient pas présentes à proximité des sites d’échantillonnage.

Certaines séquences d’ADN 12S ambigües (Multiple hits) sont identifiées comme appartenant à plus qu’une espèce.
Des espèces autres que les poissons ont été détectées avec les amorces 12S. Par contre, comme les amorces ne sont pas spécifiques à ces autres espèces et que la base de données n’est pas faite pour les autres espèces, les résultats obtenus ne sont là qu’à titre indicatif.

De plus, nous suggérons fortement de tenir compte d’un seuil du nombre de séquences limites pour la détection d’une espèce. Ce seuil est déterminé de manière à tenir compte des erreurs et/ou artefacts de séquençage (Brown et al. 2015) et des séquences mal attribuées aux différents échantillons (« index jumps-bleeding ») – Schnell et al 2015.

{{< pagebreak >}}

# Annexes

## Annexe 1 : Procédures de prévention de la contamination

Les réactions de PCR sont effectuées dans un laboratoire dédié à la PCR de métagénomique pour les échantillons ADN environnemental.

L'ensemble du matériel est préalablement décontaminé avec une solution d'hypochlorite de sodium dilué et rincé à l'eau Milli-Q.

Le personnel porte en tout temps sarrau propre et gants stériles.

Le personnel est formé pour la décontamination et les exigences que demande le travail avec les échantillons d'ADN environnemental.

## Annexe 2 : Protocole de métagénomique

Le protocole utilisé est décrit dans Berger et al. 2020.

L'approche utilisée est l'approche 'unique dual-indexing' avec deux barcodes de 8 paires de bases permettant d'identifier les échantillons. Cet identifiant permet de regrouper les échantillons de diverses stations et de les séquencer sans perdre l'information individuelle de chaque échantillon. Afin de vérifier la présence possible de contamination lors de la PCR, un contrôle négatif de PCR est ajouté pour chaque amorce-identifiant.

Chaque réaction PCR pour le 12S comprend 12,5 µl de Qiagen MasterMix, 2 µl de chaque amorce (10 µM), 5,5 µl diH20 et 3 µl d'ADNe. L'amplification suit le programme suivant : 15 minutes à 95°C, 35 cycles d'amplification (30s à 94°C, 90s à 65°C, 60s à 72°C) et une élongation finale de 10 minutes à 72°C.

Le résultat des PCRs et l'absence de contamination sont vérifiés par gel d'agarose 1.5%.

Une fraction de chaque échantillon amplifié et témoin négatif de mastermix test est ensuite nettoyée par billes paramagnétiques (Axygen) en suivant le protocole du fabriquant, éluée dans 35 µl d'eau et quantifiée par méthode de fluorescence à l'aide du Ultra High Sensitivity dsDNA Quantitation kit (AccuClear) avec le Agilent Biotek Synergy LX.

La librairie (ensemble d'échantillons) a été préparée de façon à ce que chaque échantillon soit représenté par la même quantité d'ADN amplifié. La librairie est purifiée en utilisant le paramagnetic bead-based post-PCR clean up kit (Axygen) afin d'obtenir une profondeur de séquençage égale entre chaque site d'échantillonnage.

La concentration et la distribution de la taille de fragments de la librairie sont analysées sur l'Agilent 2100 Bioanalyzer.

Les échantillons ont été séquencés sur le séquenceur AVITI de Element Biosciences en utilisant le 2x300 Sequencing kit selon les instructions du manufacturier.


# Références

Berger C, Hernandez C, Laporte M, Côté G, Paradis Y, Normandeau E, Bernatchez L (2020) Fine-scale spatial structuration of fish communities within river revealed by environmental DNA metabarcoding. Environmental DNA.

Boivin-Deslile D, Laporte M, Burton F, Dion R, Normandeau E, Bernatchez L (2020) Using environmental DNA (eDNA) for evaluation of freshwater fish communities: comparison with established gillnet surveys. Environmental DNA.

Brown SP, Veach AM, Rigdon-Huss AR, Grond K, Lickteig SK, Lothamer K, Oliver AK, Jumpponen A (2015) Scraping the bottom of the barrel: are rare high throughput sequences artifacts? Fungal Ecology 13:221-225.

Iwasaki W, Fukunaga T, Isagozawa R, Yamada K, Maeda Y, Satoh TP, Sado T, Mabuchi K, Takeshima H, Miya M, Nishida M (2013) MitoFish and MitoAnnotator: A Mitochondrial Genome Database of Fish with an Accurate and Automatic Annotation Pipeline. Molecular Biology and Evolution 30(11): 2531–2540.

Miya M, Sato Y, Fukunaga T, Sado T, Poulsen JY, Sato K, Minamoto T, Yamamoto S, Yamanaka H, Araki H, Kondoh M, Iwasaki W (2015) MiFish, a set of universal PCR primers for metabarcoding environmental DNA from fishes: detection of more than 230 subtropical marine species. R.Soc.Open sci. 2(7).

Schnell IB, Bohmann K, Gilbert MTP (2015) Tag jumps illuminated – reducing sequence-to-sample misidentifications in metabarcoding studies. Molecular Ecology Resources. 15: 1289-1303.

---

*Rapport généré automatiquement par barqueReport - `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`*
